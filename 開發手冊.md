# 開發手冊

## 2025-07-12 更新

### 進度摘要
- 已完成第二階段「核心 API 開發」
- Device 與 Menu 資料表結構已調整，Migration 檔已產生
- 程式碼已通過建置，待資料庫啟動後執行 migration

### API 路由
- 認證：POST `/api/v1/auth`，傳入 `{ deviceCode }`，回傳 JWT Token
- 菜單查詢：GET `/api/v1/menu?version=4`，需 JWT 驗證
- 菜單更新：POST `/api/v1/menu`，需 Admin 權限
- 批次訂單上傳：POST `/api/v1/orders/bulk`，需 JWT 驗證
- 訂單查詢：GET `/api/v1/orders`，支援分頁與日期區間查詢

### JWT 驗證
- 需於 HTTP Header 加入 `Authorization: Bearer <token>`
- Token 由 `/api/v1/auth` 取得，有效期 20 小時
- 角色權限（如 Admin）需於 JWT Claim 設定

### 資料庫結構
- Device：新增 DeviceCode 欄位，唯一且必填
- Menu：改為版本化設計，內容以 JSON 儲存
- 其餘資料表（Order, OrderItem, User）結構不變

### 開發注意事項
- 需先啟動 PostgreSQL，並確認連線字串正確
- Migration 需於資料庫啟動後執行：`dotnet ef database update`
- API 測試建議使用 Postman 或 Swagger

--- 

## 2025-07-12 更新（第三階段）

### 權限分級（RBAC）
- JWT 內含角色資訊（Admin/Manager/Staff）
- API 端點可用 [Authorize(Roles=...)] 控制存取

### API 路由補充
- 使用者登入：POST `/api/v1/auth/user-login`，傳入 `{ account, password }`，回傳 JWT
- 報表查詢：GET `/api/v1/reports?from=2025-07-01&to=2025-07-12`，需 Manager 以上權限
- 報表 CSV 匯出：GET `/api/v1/reports/csv?from=...&to=...`，需 Manager 以上權限
- 使用者管理：
  - GET `/api/v1/users` 查詢所有使用者（Admin）
  - POST `/api/v1/users` 建立新使用者（Admin）
  - PUT `/api/v1/users/{id}` 修改密碼/角色（Admin）
  - DELETE `/api/v1/users/{id}` 刪除使用者（Admin）

### 注意事項
- 權限驗證失敗會回傳 401/403
- 建議先建立一組 Admin 帳號以利管理
- 密碼需以 SHA256 雜湊儲存

--- 