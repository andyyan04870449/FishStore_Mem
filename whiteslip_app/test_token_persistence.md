# iOS APP 權杖持久化功能測試指南

## 功能概述

修復後的 iOS APP 現在具備完整的權杖持久化功能：

1. **自動權杖保存**：登入成功後，JWT 權杖會自動保存到本地儲存
2. **權杖有效性驗證**：應用程式啟動時會驗證已保存的權杖是否有效
3. **自動重新導向**：權杖失效時會自動清除本地資料並導向登入頁面
4. **權杖過期處理**：API 呼叫時遇到 401 錯誤會自動清除權杖

## 測試步驟

### 1. 正常登入流程測試

1. 啟動應用程式
2. 輸入有效的 6 位數授權碼
3. 點擊登入按鈕
4. 驗證成功導向主畫面
5. 檢查權杖是否已保存到本地

### 2. 權杖持久化測試

1. 完成正常登入
2. 關閉應用程式
3. 重新啟動應用程式
4. 驗證是否直接進入主畫面（無需重新登入）
5. 檢查權杖是否仍然有效

### 3. 權杖過期處理測試

1. 完成正常登入
2. 在後端使權杖失效（或等待權杖自然過期）
3. 嘗試執行需要認證的操作（如更新菜單）
4. 驗證是否自動導向登入頁面
5. 檢查本地權杖是否已清除

### 4. 網路中斷恢復測試

1. 完成正常登入
2. 斷開網路連線
3. 執行離線操作（如新增訂單）
4. 恢復網路連線
5. 驗證是否自動同步離線資料
6. 檢查權杖是否仍然有效

## 技術實作細節

### 權杖保存機制

- 使用 `SharedPreferences` 保存 JWT 權杖
- 權杖保存在 `jwt_token` 鍵值下
- 同時保存裝置資訊到本地資料庫

### 權杖驗證機制

- 應用程式啟動時自動驗證權杖
- 使用 `/menu` API 端點進行權杖驗證
- 驗證失敗時自動清除本地資料

### 權杖過期處理

- API 攔截器監聽 401 錯誤
- 自動清除過期的權杖
- 通知 AppProvider 更新認證狀態
- 自動導向登入頁面

### 狀態管理

- AppProvider 管理全域認證狀態
- 使用 ChangeNotifier 通知 UI 更新
- 各畫面監聽認證狀態變化

## 預期行為

### 正常情況
- 登入後權杖持久保存
- 重新啟動應用程式無需重新登入
- 權杖有效期間可正常使用所有功能

### 異常情況
- 權杖過期時自動清除並要求重新登入
- 網路錯誤時保持離線功能
- 網路恢復時自動同步資料

## 注意事項

1. 權杖有效期由後端控制
2. 本地權杖清除會同時清除裝置資訊
3. 離線模式下仍可正常使用基本功能
4. 權杖過期時會自動導向登入頁面，無需手動操作 