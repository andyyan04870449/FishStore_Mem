
# ç™½å–®æ©Ÿé»é¤åˆ—å°ç³»çµ± â€” å¾Œç«¯æŠ€è¡“ç™½çš®æ›¸ v1.0ï¼ˆä¸­æ–‡ï¼‰

> æœ¬æ–‡ä»¶æ—¨åœ¨æä¾›è¶³å¤ çš„æŠ€è¡“ç´°ç¯€ï¼Œè®“ AIï¼ˆä¾‹å¦‚â€¯Codexã€GPTâ€‘o3ï¼‰åœ¨ç„¡å…¶ä»–èªªæ˜çš„æƒ…æ³ä¸‹å³å¯å¾é›¶é–‹å§‹å¯¦ä½œå¾Œç«¯ APIã€‚

---

## 1. ç›®æ¨™èˆ‡ç¯„åœ
- æœå‹™ **iPad é»é¤ App**ï¼Œæä¾›ã€Œèœå–®åŒæ­¥ã€é›¢ç·šè¨‚å–®ä¸Šå‚³ã€å ±è¡¨åŒ¯å‡ºã€è£ç½®æˆæ¬Šã€ç­‰ REST ä»‹é¢ã€‚  
- **ä¸** ç”¢ç”Ÿç™¼ç¥¨ã€ä¸æ•´åˆé‡‘æµã€‚  
- å¿…é ˆæ”¯æŒé›¢ç·šæ‰¹æ¬¡åŒæ­¥ï¼Œä¸¦å…·å‚™è§’è‰²æ¬Šé™æ§ç®¡ã€‚

---

## 2. æŠ€è¡“æ£§èˆ‡åŸ·è¡Œç’°å¢ƒ
| åˆ†é¡ | è¦æ ¼ |
|------|------|
| èªè¨€ | **C#Â 13** |
| å¹³å° | **.NETÂ 8 Minimal API** |
| å®¹å™¨ | `mcr.microsoft.com/dotnet/aspnet:8.0-alpine` |
| è³‡æ–™åº« | **PostgreSQLÂ 15** |
| ORM | Entity Framework CoreÂ 8 (`Npgsql` provider) |
| é©—è­‰ | **JWT (HS256)**ï¼Œå­˜æ–¼ `Authorization: Bearer <token>` |
| æ—¥èªŒ | Serilogï¼ˆè¼¸å‡ºåˆ° Console èˆ‡ Seqï¼‰ |

---

## 3. ç’°å¢ƒè®Šæ•¸
| åç¨± | ç¯„ä¾‹ | ç”¨é€” |
|------|------|------|
| `DB_CONN` | `Host=db;Port=5432;Username=white;Password=slip;Database=wsl` | PostgreSQL é€£ç·šå­—ä¸² |
| `JWT_SECRET` | `CHANGE_ME_32_BYTE_SECRET` | JWT ç°½ç« å¯†é‘° |
| `JWT_ISSUER` | `white-slip-api` | JWT â€¯iss |
| `JWT_AUDIENCE` | `white-slip-app` | JWT â€¯aud |
| `LOG_LEVEL` | `Information` | Serilog æœ€ä½å±¤ç´š |

---

## 4. è³‡æ–™æ¨¡å‹èˆ‡ DDL
```sql
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

CREATE TABLE devices (
  device_id    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  jwt          TEXT NOT NULL,
  last_seen    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE users (
  user_id    UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  account    TEXT UNIQUE NOT NULL,
  hashed_pw  TEXT NOT NULL,
  role       TEXT NOT NULL CHECK (role IN ('admin','manager','staff')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE menus (
  sku        TEXT PRIMARY KEY,
  name       TEXT NOT NULL,
  price      NUMERIC(10,2) NOT NULL,
  category   TEXT,
  version    INT NOT NULL,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE orders (
  order_id     TEXT PRIMARY KEY,
  business_day DATE NOT NULL,
  total        NUMERIC(10,2) NOT NULL,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE order_items (
  order_id   TEXT REFERENCES orders(order_id) ON DELETE CASCADE,
  line_no    INT,
  sku        TEXT NOT NULL,
  name       TEXT NOT NULL,
  qty        INT NOT NULL,
  unit_price NUMERIC(10,2) NOT NULL,
  subtotal   NUMERIC(10,2) NOT NULL,
  PRIMARY KEY (order_id, line_no)
);
```

---

## 5. REST API å®šç¾©

### 5.1 é€šå‰‡
- æ‰€æœ‰æˆåŠŸå›æ‡‰çš†å¸¶ `X-Trace-Id` ä¾›å‰å¾Œç«¯æ—¥èªŒé—œè¯ã€‚
- å¤±æ•—å›æ‡‰æ ¼å¼ï¼š
```json
{
  "traceId": "c7e9d...",
  "error": "BadRequest",
  "message": "è©³ç´°éŒ¯èª¤èªªæ˜"
}
```

### 5.2 è·¯ç”±ä¸€è¦½
| Method | Path | Auth | èªªæ˜ |
|--------|------|------|------|
| POST | `/api/v1/auth` | ç„¡ | è¼¸å…¥ `deviceCode` å–å¾— JWT |
| GET | `/api/v1/menu` | JWT | æ¯”å°ç‰ˆæœ¬è™Ÿå¾Œå›å‚³èœå–® JSON |
| POST | `/api/v1/orders/bulk` | JWT | é›¢ç·šè¨‚å–®æ‰¹æ¬¡ä¸Šå‚³ï¼ˆ<=20Â ç­†ï¼‰ |
| GET | `/api/v1/reports` | JWT (Managerâ†‘) | åŒ¯å‡ºæŒ‡å®šæ—¥æœŸå€æ®µä¹‹ç‡Ÿæ¥­ CSV |

#### 5.2.1 `/auth`
```json
POST /api/v1/auth
{
  "deviceCode": "ABC123"
}
```
- æˆåŠŸ `201 Created` â†’ `{"token": "...", "expiresIn": 72000}`
- å¤±æ•—ï¼š`403` æœªæ ¸å¯ã€`409` å·²è¨»å†Š

#### 5.2.2 `/menu`
`GET /api/v1/menu?version=4`  
- è‹¥å·²æ˜¯æœ€æ–°ç‰ˆ â†’ `304 Not Modified`
```json
200 OK
{
  "version": 5,
  "items": [
    { "sku": "FC-Sweet-01", "name": "å¥¶æ²¹å¡å£«é”", "price": 65 }
  ]
}
```

#### 5.2.3 `/orders/bulk`
```json
POST /api/v1/orders/bulk
[
  {
    "orderId": "20250711-0001",
    "createdAt": "2025-07-11T23:25:12+08:00",
    "items": [
      { "sku": "FC-Sweet-06", "name": "æŠ¹èŒ¶ç´…è±†", "qty": 2, "unitPrice": 70, "subtotal": 140 }
    ],
    "discounts": [],
    "total": 140
  }
]
```
- å›å‚³ `202 Accepted`ï¼š`{"stored": 1, "duplicate": 0}`

---

## 6. æ ¸å¿ƒæµç¨‹

### 6.1 é›¢ç·šé‡é€
1. App å•Ÿå‹•è‡ªå‹•å– `unsynced=true` è¨‚å–®ã€‚
2. æ¯æ‰¹ 20Â ç­†ï¼Œä»¥åºåˆ—åŒ– JSON ç™¼é€ `/orders/bulk`ã€‚
3. æˆåŠŸ â†’ æ¨™ `synced=true`ï¼›ç¶²è·¯/ä¼ºæœå™¨éŒ¯èª¤ â†’ é€€å‡ºé‡é€è¿´åœˆã€‚

### 6.2 æµæ°´è™Ÿ
- å½¢å¦‚ `YYYYMMDD-NNNN`ã€‚  
- ã€Œç‡Ÿæ¥­æ—¥ã€å®šç¾©ï¼šæ¯æ—¥ 02:00 åˆ‡æ›ï¼›è·¨æ—¥ä½† <Â 02:00 ä»å±¬å‰ä¸€ç‡Ÿæ¥­æ—¥ã€‚

---

## 7. Docker èˆ‡éƒ¨ç½²
### 7.1 `Dockerfile`
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine AS base
WORKDIR /app
ENV ASPNETCORE_URLS=http://+:8080

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY . .
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
COPY --from=build /app/publish .
ENTRYPOINT ["dotnet","WhiteSlip.Api.dll"]
```

### 7.2 `docker-compose.yml`
```yaml
services:
  api:
    build: .
    ports: ["8080:8080"]
    environment:
      - DB_CONN=Host=db;Port=5432;Username=white;Password=slip;Database=wsl
      - JWT_SECRET=CHANGE_ME_32_BYTE_SECRET
    depends_on: [db]
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: white
      POSTGRES_PASSWORD: slip
      POSTGRES_DB: wsl
    volumes:
      - psql:/var/lib/postgresql/data
volumes:
  psql:
```

---

## 8. æ¸¬è©¦èˆ‡ CI
| é …ç›® | å·¥å…· |
|------|------|
| å–®å…ƒæ¸¬è©¦ | `xunit` + `dotnet test` |
| æ•´åˆæ¸¬è©¦ | `Microsoft.AspNetCore.Mvc.Testing` |
| æ ¼å¼/éœæ…‹åˆ†æ | `dotnet format` + `StyleCop` |
| CI | GitHubÂ Actionsï¼šPushÂ â†’ Test â†’ Publish Docker image |

---

## 9. ç›£æ§èˆ‡ç¶­é‹
- å¥åº·æª¢æŸ¥ç«¯é»ï¼š`GET /healthz`ï¼ˆDB é€£ç·šã€ç£ç¢Ÿç©ºé–“ï¼‰  
- Metricsï¼š`/metrics` ä»¥ `prometheus-net` æš´éœ²  
- æ—¥èªŒï¼šSerilog â†’ Consoleï¼ˆJSONï¼‰â†’ Seq  
- å‚™ä»½ï¼šæ¯æ—¥ 03:00 ä»¥ `pg_dump` ä¸Šå‚³ S3 ç‰ˆæœ¬æ§ç®¡

---

## 10. æ“´å……è·¯ç·šåœ–
| éšæ®µ | åŠŸèƒ½ |
|------|------|
| v1.1 | Refresh Token / è§’è‰²ç´°åˆ† |
| v1.2 | Webhookï¼šèœå–®æ›´æ–°å³æ™‚æ¨é€è‡³ iPad |
| v2.0 | LINE OpenID Connect / é‡‘æµæ¨¡çµ„ |

---

## 11. é–‹ç™¼å®ˆå‰‡
1. **å…ˆæ›´æ–°æ–‡ä»¶å¾Œå¯«ç¨‹å¼**ï¼šä»»ä½• endpoint è®Šå‹•é ˆåŒæ­¥æ­¤æª”ã€‚  
2. PR éœ€é€šéï¼š`dotnet test`ã€`dotnet format`ã€‚  
3. æ‰€æœ‰æ–° schema è®Šæ›´éƒ½è¦æä¾›Â `EF Core Migration`ã€‚  

---

> *å®Œæˆæ­¤ç™½çš®æ›¸å¾Œï¼ŒAI å¯ç›´æ¥ï¼š*  
> 1. é€é `dotnet new web` å»ºç«‹å°ˆæ¡ˆ ğŸ‘‰ ä¾æ­¤æ–‡ä»¶å¡«å…… Model & Endpointã€‚  
> 2. å»ºç«‹ Migrationã€æ’°å¯«å–®å…ƒ/æ•´åˆæ¸¬è©¦ã€‚  
> 3. ä»¥ Docker Compose ä¸€éµå•Ÿå‹•æœ¬åœ°é–‹ç™¼ç’°å¢ƒã€‚  
